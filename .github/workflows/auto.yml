name: Build and Deploy to Test Environment

on: 
  push:
    branches:
      [test-deployment]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
      
      - name: SSH Setup 
        uses: webfactory/ssh-agent@v0.5.4 
        with:
          ssh-private-key: ${{ secrets.PRIVATE_DEPENDENCY }}

      - name: Clone publicgoods-website-test
        # uses: actions/checkout@v2
        # with:
        #   repository: DPGAlliance/DPGAlliance.github.io
        #   ref: refs/heads/main
        #   ssh-key: ${{ secrets.PRIVATE_DEPENDENCY }}
        #   path: publicgoods-website-test
        run: git clone git@github.com:DPGAlliance/DPGAlliance.github.io.git ../publicgoods-website-test 
      # - name: Checkout
      #   uses: actions/checkout@v2
      #   with:
      #     repository: DPGAlliance/DPGAlliance.github.io
      #     ref: refs/heads/main
      #     token: ${{ secrets.GITHUB_TOKEN }}
      # - name: Clone publicgoods-candidates
      #   run: git clone https://github.com/DPGAlliance/publicgoods-candidates.git ../publicgoods-candidates
      - name: Run static.bash
        run: bash scripts/static.bash
      # - name: Generating DPG's
      #   run: cd packages/automation && npm install && node generate_dpgs.js
      # - name: Generating Nominees
      #   env:
      #       CLIENTID: ${{ secrets.CLIENTID}}
      #       CLIENTSECRET: ${{ secrets.CLIENTSECRET}}
      #   run: cd packages/automation && node generate_nominees.js
      # - name: Downloading nominees.json file into packages/registry/src
      #   run:  curl --location --request GET 'https://api.digitalpublicgoods.net/nominees/' -o packages/registry/src/nominees.json 
      - name: Run npm i at root for needed react-scripts package below
        run: npm install
      - name: Consolidating DPG's and nominees from new API for registry page table
        run: cd packages/automation && node consolidate_data.js
      - name: Generating registry, eligibility and map pages
        run: cd packages/automation && node index.js
      - name: Softlink required dependencies
        run:  |
          ln -s ../../../../publicgoods-website-test/wp-includes/ packages/eligibility/public/wp-includes;
          ln -s ../../../../publicgoods-website-test/wp-content/ packages/eligibility/public/wp-content;
          ln -s ../../../../publicgoods-website-test/wp-includes/ packages/registry/public/wp-includes;
          ln -s ../../../../publicgoods-website-test/wp-content/ packages/registry/public/wp-content;
          ln -s ../../../../publicgoods-website-test/wp-includes/ packages/map/public/wp-includes;
          ln -s ../../../../publicgoods-website-test/wp-content/ packages/map/public/wp-content;
          ln -s ../../../../publicgoods-website-test/wp-includes/ packages/roadmap/public/wp-includes;
          ln -s ../../../../publicgoods-website-test/wp-content/ packages/roadmap/public/wp-content;
      - name: Build packages/eligibility
        run: cd packages/eligibility && npm install && npm run build
      - name: Build packages/registry
        run: cd packages/registry && npm install && npm run build
      #- name: Build packages/map
      #  run: cd packages/map && npm install && npm run build
      #  env:
      #    NEXT_PUBLIC_MAPBOX_TOKEN: ${{ secrets.NEXT_PUBLIC_MAPBOX_TOKEN }}
      #    NEXT_PUBLIC_SHEET_ID: ${{ secrets.NEXT_PUBLIC_SHEET_ID }}
      - name: Build packages/roadmap
        run: cd packages/roadmap && npm install && npm run build
      - name: run movefiles.bash
        run:  bash scripts/moveFiles.bash
      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: artifacts
          path: /home/runner/work/publicgoods-scripts/publicgoods-website-test


  deploy_to_test:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Configuring commit Author
        run: |
          git config --global user.email "96251909+dpgabot@users.noreply.github.com"
          git config --global user.name "dpgabot" 

      - name: Download Artifacts
        uses: actions/download-artifact@v3
        with: 
            name: artifacts
            path: artifacts/
      
      - name: Checkout Dev Target
        uses: actions/checkout@v2
        with:
          repository: DPGAlliance/DPGAlliance.github.io
          path: "testenv"
          token: ${{secrets.PAT }}
      
      - name: Push to Test Environment 
        run: |
          cp -r artifacts/* testenv/
          cd testenv 
          touch .nojekyll
          git remote set-url origin https://github.com/DPGAlliance/DPGAlliance.github.io.git 
          git add . 
          git commit -am "BLD: $GITHUB_SHA" || true 
          git push --set-upstream origin main
